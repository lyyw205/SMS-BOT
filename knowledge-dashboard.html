<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <title>SMS Bot · Knowledge Base 관리</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <style>
    :root {
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      color-scheme: light;
    }
    body {
      margin: 0;
      padding: 0;
      background: #f5f5f7;
      color: #111827;
    }
    .page {
      max-width: 960px;
      margin: 0 auto;
      padding: 24px 16px 64px;
    }
    h1 {
      font-size: 1.6rem;
      margin-bottom: 4px;
    }
    .subtitle {
      font-size: 0.9rem;
      color: #6b7280;
      margin-bottom: 16px;
    }
    .card {
      background: #ffffff;
      border-radius: 12px;
      padding: 16px 16px 20px;
      box-shadow: 0 8px 20px rgba(15,23,42,0.06);
      margin-bottom: 16px;
    }
    .card-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 8px;
      margin-bottom: 12px;
    }
    .card-title {
      font-weight: 600;
      font-size: 1rem;
    }
    .badge {
      font-size: 0.75rem;
      padding: 2px 8px;
      border-radius: 999px;
      background: #eff6ff;
      color: #1d4ed8;
    }
    form {
      display: grid;
      grid-template-columns: repeat(auto-fit,minmax(220px,1fr));
      gap: 10px 16px;
      align-items: flex-start;
    }
    label {
      font-size: 0.8rem;
      font-weight: 500;
      color: #374151;
      display: block;
      margin-bottom: 4px;
    }
    input[type="text"],
    select,
    textarea {
      width: 100%;
      box-sizing: border-box;
      border-radius: 8px;
      border: 1px solid #d1d5db;
      padding: 8px 10px;
      font-size: 0.9rem;
      outline: none;
      background: #f9fafb;
    }
    textarea {
      min-height: 70px;
      resize: vertical;
    }
    input[type="text"]:focus,
    select:focus,
    textarea:focus {
      border-color: #6366f1;
      background: #ffffff;
      box-shadow: 0 0 0 1px rgba(99,102,241,0.2);
    }
    .form-row-span {
      grid-column: 1 / -1;
    }
    .form-actions {
      display: flex;
      gap: 8px;
      align-items: center;
      margin-top: 6px;
      flex-wrap: wrap;
    }
    button {
      border-radius: 999px;
      border: none;
      padding: 8px 14px;
      font-size: 0.85rem;
      font-weight: 500;
      cursor: pointer;
      display: inline-flex;
      align-items: center;
      gap: 4px;
      transition: transform 0.05s ease, box-shadow 0.1s ease, background 0.1s ease;
    }
    button:active {
      transform: translateY(1px);
      box-shadow: none;
    }
    .btn-primary {
      background: #4f46e5;
      color: #fff;
      box-shadow: 0 4px 10px rgba(79,70,229,0.3);
    }
    .btn-secondary {
      background: #e5e7eb;
      color: #111827;
    }
    .btn-danger {
      background: #ef4444;
      color: #fff;
    }
    .status {
      font-size: 0.8rem;
      color: #6b7280;
      margin-top: 6px;
      min-height: 18px;
    }
    table {
      width: 100%;
      border-collapse: collapse;
      font-size: 0.85rem;
    }
    th, td {
      border-bottom: 1px solid #e5e7eb;
      padding: 8px 6px;
      text-align: left;
      vertical-align: top;
    }
    th {
      font-size: 0.8rem;
      text-transform: uppercase;
      letter-spacing: 0.03em;
      color: #6b7280;
      background: #f3f4f6;
    }
    tbody tr:hover {
      background: #f9fafb;
    }
    .mono {
      font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
      font-size: 0.8rem;
    }
    .pill {
      display: inline-flex;
      align-items: center;
      padding: 2px 8px;
      border-radius: 999px;
      font-size: 0.7rem;
      font-weight: 500;
      background: #e5e7eb;
      color: #374151;
      gap: 4px;
    }
    .pill-blue {
      background: #dbeafe;
      color: #1d4ed8;
    }
    .table-actions {
      display: flex;
      gap: 6px;
      flex-wrap: wrap;
    }
    @media (max-width: 640px) {
      th:nth-child(1), td:nth-child(1) { width: 60px; }
      th:nth-child(2), td:nth-child(2) { width: 110px; }
    }
  </style>
</head>
<body>
  <div class="page">
    <h1>Knowledge Base 관리</h1>
    <p class="subtitle">
      인텐트별로 참고할 설명/규칙/안내 텍스트를 관리합니다.
      LLM이 답변 생성할 때 이 내용을 참고해서 더 일관된 답변을 만들게 할 수 있어요.
    </p>

    <div class="card">
      <div class="card-header">
        <div class="card-title">Supabase 설정</div>
        <span class="badge">knowledge_base / intents 사용</span>
      </div>
      <div style="font-size:0.8rem;color:#4b5563;line-height:1.4;">
        아래 상수 <span class="mono">SUPABASE_URL</span> / <span class="mono">SUPABASE_ANON_KEY</span> 를
        네 프로젝트 값으로 교체한 뒤 사용하세요.
      </div>
    </div>

    <div class="card">
      <div class="card-header">
        <div class="card-title">Knowledge 추가 / 수정</div>
        <span id="edit-mode-pill" class="pill" style="display:none;">편집 모드</span>
      </div>

      <form id="kb-form">
        <div>
          <label for="category">카테고리 (intent 이름과 맞추는 것을 추천)</label>
          <input type="text" id="category" placeholder="예: CHECKIN_TIME" />
          <div style="margin-top:4px;">
            <select id="category-select">
              <option value="">↳ intents에서 선택 (선택 시 위 입력칸에 채워짐)</option>
            </select>
          </div>
        </div>
        <div>
          <label for="title">제목</label>
          <input type="text" id="title" placeholder="예: 체크인/체크아웃 기본 안내" />
        </div>
        <div class="form-row-span">
          <label for="content">내용 (LLM이 참고할 설명 텍스트)</label>
          <textarea id="content" placeholder="예: 체크인은 보통 오후 ~시부터 가능하며, 체크아웃은 ~시에 마감됩니다. 실제 시간은 지점/날짜에 따라 약간 달라질 수 있어요."></textarea>
        </div>
        <div class="form-row-span">
          <label for="metadata">Metadata (옵션, JSON)</label>
          <textarea id="metadata" placeholder='예: {"lang":"ko","priority":1,"note":"체크인 관련"}'></textarea>
        </div>
        <div class="form-actions form-row-span">
          <button type="submit" class="btn-primary" id="submit-btn">+ Knowledge 저장</button>
          <button type="button" class="btn-secondary" id="cancel-edit-btn" style="display:none;">취소</button>
          <div class="status" id="form-status"></div>
        </div>
      </form>
    </div>

    <div class="card">
      <div class="card-header">
        <div class="card-title">Knowledge 목록</div>
        <button type="button" class="btn-secondary" id="reload-btn">새로고침</button>
      </div>
      <div class="status" id="list-status">로딩 중...</div>
      <div style="overflow-x:auto;margin-top:8px;">
        <table>
          <thead>
            <tr>
              <th>ID</th>
              <th>카테고리</th>
              <th>제목</th>
              <th>내용</th>
              <th>메타데이터</th>
              <th>액션</th>
            </tr>
          </thead>
          <tbody id="kb-tbody">
            <!-- rows -->
          </tbody>
        </table>
      </div>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script>
    // TODO: 여기를 네 Supabase 프로젝트 값으로 교체
    const SUPABASE_URL = "https://YOUR_PROJECT_ID.supabase.co";
    const SUPABASE_ANON_KEY = "YOUR_SUPABASE_ANON_KEY";

    const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

    const tbody = document.getElementById("kb-tbody");
    const listStatusEl = document.getElementById("list-status");
    const formStatusEl = document.getElementById("form-status");
    const formEl = document.getElementById("kb-form");
    const reloadBtn = document.getElementById("reload-btn");
    const submitBtn = document.getElementById("submit-btn");
    const cancelEditBtn = document.getElementById("cancel-edit-btn");
    const editModePill = document.getElementById("edit-mode-pill");

    const categoryInput = document.getElementById("category");
    const categorySelect = document.getElementById("category-select");
    const titleInput = document.getElementById("title");
    const contentInput = document.getElementById("content");
    const metadataInput = document.getElementById("metadata");

    let editingId = null;

    function setFormStatus(msg, isError = false) {
      formStatusEl.textContent = msg || "";
      formStatusEl.style.color = isError ? "#b91c1c" : "#6b7280";
    }
    function setListStatus(msg, isError = false) {
      listStatusEl.textContent = msg || "";
      listStatusEl.style.color = isError ? "#b91c1c" : "#6b7280";
    }

    function enterEditMode(row) {
      editingId = row.id;
      categoryInput.value = row.category || "";
      titleInput.value = row.title || "";
      contentInput.value = row.content || "";
      metadataInput.value = row.metadata ? JSON.stringify(row.metadata, null, 2) : "";

      submitBtn.textContent = "✓ Knowledge 수정 저장";
      cancelEditBtn.style.display = "inline-flex";
      editModePill.style.display = "inline-flex";
      setFormStatus("편집 모드: 저장하면 해당 Knowledge가 수정됩니다.");
    }

    function resetForm() {
      editingId = null;
      formEl.reset();
      submitBtn.textContent = "+ Knowledge 저장";
      cancelEditBtn.style.display = "none";
      editModePill.style.display = "none";
      setFormStatus("");
    }

    async function loadIntentsForCategorySelect() {
      const { data, error } = await supabase
        .from("intents")
        .select("name")
        .order("name", { ascending: true });

      if (error) {
        console.error("loadIntentsForCategorySelect error:", error);
        return;
      }

      categorySelect.innerHTML = '<option value="">↳ intents에서 선택 (선택 시 위 입력칸에 채워짐)</option>';
      data.forEach((it) => {
        const opt = document.createElement("option");
        opt.value = it.name;
        opt.textContent = it.name;
        categorySelect.appendChild(opt);
      });

      categorySelect.addEventListener("change", () => {
        if (categorySelect.value) {
          categoryInput.value = categorySelect.value;
        }
      });
    }

    async function loadKnowledge() {
      setListStatus("로딩 중...");
      tbody.innerHTML = "";
      const { data, error } = await supabase
        .from("knowledge_base")
        .select("*")
        .order("category", { ascending: true })
        .order("id", { ascending: true });

      if (error) {
        console.error("loadKnowledge error:", error);
        setListStatus("목록을 불러오지 못했습니다.", true);
        return;
      }

      if (!data || data.length === 0) {
        setListStatus("등록된 Knowledge가 없습니다. 위 폼에서 추가하세요.");
        return;
      }

      setListStatus(`총 ${data.length}개 항목`);

      data.forEach((row) => {
        const tr = document.createElement("tr");

        const tdId = document.createElement("td");
        tdId.textContent = row.id;
        tdId.className = "mono";

        const tdCat = document.createElement("td");
        tdCat.innerHTML = `<span class="pill pill-blue">${row.category}</span>`;

        const tdTitle = document.createElement("td");
        tdTitle.textContent = row.title;

        const tdContent = document.createElement("td");
        tdContent.textContent = (row.content || "").length > 80
          ? row.content.slice(0, 80) + "..."
          : row.content || "";

        const tdMeta = document.createElement("td");
        if (row.metadata) {
          tdMeta.innerHTML = `<pre class="mono" style="white-space:pre-wrap;max-height:80px;overflow:auto;">${JSON.stringify(row.metadata)}</pre>`;
        } else {
          tdMeta.innerHTML = `<span class="pill">없음</span>`;
        }

        const tdActions = document.createElement("td");
        const actionsDiv = document.createElement("div");
        actionsDiv.className = "table-actions";

        const editBtn = document.createElement("button");
        editBtn.type = "button";
        editBtn.className = "btn-secondary";
        editBtn.textContent = "수정";
        editBtn.onclick = () => enterEditMode(row);

        const delBtn = document.createElement("button");
        delBtn.type = "button";
        delBtn.className = "btn-danger";
        delBtn.textContent = "삭제";
        delBtn.onclick = async () => {
          const ok = window.confirm(
            `정말 삭제할까요?\n\n[${row.category}] ${row.title}`
          );
          if (!ok) return;
          const { error: delError } = await supabase
            .from("knowledge_base")
            .delete()
            .eq("id", row.id);
          if (delError) {
            console.error("delete KB error:", delError);
            alert("삭제 중 오류가 발생했습니다.");
            return;
          }
          if (editingId === row.id) {
            resetForm();
          }
          await loadKnowledge();
        };

        actionsDiv.appendChild(editBtn);
        actionsDiv.appendChild(delBtn);
        tdActions.appendChild(actionsDiv);

        tr.appendChild(tdId);
        tr.appendChild(tdCat);
        tr.appendChild(tdTitle);
        tr.appendChild(tdContent);
        tr.appendChild(tdMeta);
        tr.appendChild(tdActions);
        tbody.appendChild(tr);
      });
    }

    formEl.addEventListener("submit", async (e) => {
      e.preventDefault();
      setFormStatus("");

      const category = categoryInput.value.trim();
      const title = titleInput.value.trim();
      const content = contentInput.value.trim();
      const metadataRaw = metadataInput.value.trim();

      if (!category || !title || !content) {
        setFormStatus("카테고리, 제목, 내용은 필수입니다.", true);
        return;
      }

      let metadata = null;
      if (metadataRaw) {
        try {
          metadata = JSON.parse(metadataRaw);
        } catch (err) {
          setFormStatus("metadata가 유효한 JSON 형식이 아닙니다.", true);
          return;
        }
      }

      submitBtn.disabled = true;
      submitBtn.textContent = editingId ? "저장 중..." : "추가 중...";

      try {
        if (editingId) {
          const { error } = await supabase
            .from("knowledge_base")
            .update({
              category,
              title,
              content,
              metadata,
              updated_at: new Date().toISOString(),
            })
            .eq("id", editingId);

          if (error) {
            console.error("update KB error:", error);
            setFormStatus("수정 중 오류가 발생했습니다.", true);
          } else {
            setFormStatus("수정 완료!");
            resetForm();
            await loadKnowledge();
          }
        } else {
          const { error } = await supabase
            .from("knowledge_base")
            .insert({ category, title, content, metadata });

          if (error) {
            console.error("insert KB error:", error);
            setFormStatus("추가 중 오류가 발생했습니다.", true);
          } else {
            setFormStatus("추가 완료!");
            formEl.reset();
            await loadKnowledge();
          }
        }
      } finally {
        submitBtn.disabled = false;
        submitBtn.textContent = editingId ? "✓ Knowledge 수정 저장" : "+ Knowledge 저장";
      }
    });

    cancelEditBtn.addEventListener("click", () => {
      resetForm();
    });

    reloadBtn.addEventListener("click", () => {
      loadKnowledge();
    });

    // 초기 로딩
    loadIntentsForCategorySelect();
    loadKnowledge();
  </script>
</body>
</html>
